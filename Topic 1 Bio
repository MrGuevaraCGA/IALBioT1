<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Canopy & Plant Communities | MSc Thesis</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Custom Config for Moss Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        moss: {
                            light: '#4ade80',
                            DEFAULT: '#15803d', // Primary Green
                            dark: '#14532d',    // Dark Green
                            deep: '#052e16',    // Very Dark Green
                        },
                        earth: {
                            DEFAULT: '#78350f', // Brown
                            light: '#fefce8',   // Light Yellow/Beige
                        },
                        gold: {
                            DEFAULT: '#fbbf24',
                            dark: '#d97706',
                        }
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* 3D Gamified Styles */
        body {
            background-color: #f0fdf4; /* Very light green tint */
            background-image: radial-gradient(#dcfce7 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .card-3d {
            transition: all 0.1s;
            border-bottom: 6px solid rgba(0,0,0,0.2);
            transform: translateY(0);
        }

        .card-3d:active {
            transform: translateY(4px);
            border-bottom: 2px solid rgba(0,0,0,0.2);
        }

        .nav-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item.active {
            background-color: #fbbf24;
            color: #052e16;
            font-weight: bold;
            transform: scale(1.05);
            box-shadow: 0 4px 0 #d97706;
        }

        .nav-item:hover:not(.active) {
            background-color: #15803d;
            transform: translateY(-2px);
        }

        .section-hidden {
            display: none;
        }

        .section-active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #dcfce7;
        }
        ::-webkit-scrollbar-thumb {
            background: #15803d;
            border-radius: 5px;
        }

        .chat-msg {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .flip-card {
            perspective: 1000px;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 1rem;
        }
        .flip-card-back {
            background-color: #14532d;
            color: white;
            transform: rotateY(180deg);
        }

        /* Modal Overlay */
        #research-modal, #sites-modal {
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        
        /* Floating Action Buttons Container */
        .fab-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .action-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            background-color: #f3f4f6;
            border-color: #15803d;
            color: #15803d;
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Navigation -->
    <nav class="bg-moss-deep text-white p-4 shadow-lg z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- UPDATED: Added cursor-pointer and onclick to make the logo/title a Home button -->
            <div class="flex items-center gap-3 cursor-pointer hover:scale-105 transition-transform" onclick="switchTab('home')">
                <i class="fa-solid fa-tree text-gold-DEFAULT text-2xl animate-bounce"></i>
                <div>
                    <h1 class="text-xl font-bold font-mono tracking-tighter">ECO-FOREST THESIS</h1>
                    <p class="text-xs text-green-300">By Aimee Pritchard | Otago University</p>
                </div>
            </div>
            
            <div class="flex flex-wrap justify-center gap-2">
                <button onclick="switchTab('home')" id="btn-home" class="nav-item active px-4 py-2 rounded-lg border-b-4 border-green-900 bg-moss-dark text-white">Home</button>
                <button onclick="switchTab('intro')" id="btn-intro" class="nav-item px-4 py-2 rounded-lg border-b-4 border-green-900 bg-moss-dark text-white">Intro</button>
                <button onclick="switchTab('methods')" id="btn-methods" class="nav-item px-4 py-2 rounded-lg border-b-4 border-green-900 bg-moss-dark text-white">Methods</button>
                <button onclick="switchTab('results')" id="btn-results" class="nav-item px-4 py-2 rounded-lg border-b-4 border-green-900 bg-moss-dark text-white">Results</button>
                <button onclick="switchTab('simulator')" id="btn-simulator" class="nav-item px-4 py-2 rounded-lg border-b-4 border-purple-600 bg-purple-900 text-white font-bold shadow-lg">‚ú® Simulator</button>
                <button onclick="switchTab('discussion')" id="btn-discussion" class="nav-item px-4 py-2 rounded-lg border-b-4 border-green-900 bg-moss-dark text-white">Discussion</button>
                <!-- UPDATED: Enhanced visibility for the Quiz button -->
                <button onclick="switchTab('quiz')" id="btn-quiz" class="nav-item px-6 py-2 rounded-lg border-b-4 border-yellow-700 bg-gold-DEFAULT text-black font-extrabold shadow-xl hover:scale-110 hover:shadow-yellow-400/50 transition-all ring-2 ring-white/30">
                    <i class="fa-solid fa-bolt animate-pulse"></i> QUIZ
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 pb-32 scroll-smooth">
        
        <!-- HOME SECTION -->
        <div id="home" class="section-active max-w-5xl mx-auto">
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div data-aos="fade-right">
                    <div class="bg-white p-8 rounded-3xl border-b-8 border-moss-dark shadow-xl" id="home-content">
                        <span class="bg-gold-DEFAULT text-black px-3 py-1 rounded-full text-sm font-bold mb-4 inline-block">MASTER OF SCIENCE</span>
                        <h2 class="text-4xl md:text-5xl font-extrabold text-moss-deep mb-4 leading-tight">
                            Canopy & Management Influences on <span class="text-moss-DEFAULT">Plant Communities</span>
                        </h2>
                        <p class="text-lg text-gray-700 mb-6">
                            Investigating native and exotic forests in Otago, New Zealand. Can exotic pine plantations support native regeneration? What about the mosses?
                        </p>
                        
                        <div class="fab-container mb-6">
                            <button onclick="speakText('home-content')" class="action-btn">
                                <i class="fa-solid fa-volume-high text-moss-DEFAULT"></i> Read Aloud
                            </button>
                            <button onclick="openResearchModal('Overview of Native Regeneration in Exotic Forests')" class="action-btn">
                                <i class="fa-solid fa-book-open text-blue-600"></i> Why This Matters?
                            </button>
                        </div>

                        <div class="flex gap-4">
                            <!-- High Contrast Button -->
                            <button onclick="switchTab('intro')" class="card-3d bg-moss-deep text-white px-8 py-4 rounded-xl font-bold text-lg w-full md:w-auto hover:bg-moss-dark transition-colors border-2 border-transparent">
                                Start Exploring <i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                            <button onclick="toggleChat()" class="card-3d bg-white text-moss-deep border-2 border-moss-deep px-6 py-4 rounded-xl font-bold w-full md:w-auto hover:bg-green-50 transition-colors">
                                Ask AI Bot <i class="fa-solid fa-robot ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div data-aos="fade-left" class="grid grid-cols-2 gap-4">
                    <div class="bg-moss-dark text-white p-6 rounded-2xl shadow-lg transform rotate-3 hover:rotate-0 transition duration-300 border border-moss-light">
                        <i class="fa-solid fa-leaf text-4xl text-gold-DEFAULT mb-2"></i>
                        <h3 class="font-bold text-xl">151 Native Species</h3>
                        <p class="text-sm opacity-90">Found under native canopies.</p>
                    </div>
                    <div class="bg-earth text-gray-800 p-6 rounded-2xl shadow-lg transform -rotate-3 hover:rotate-0 transition duration-300 mt-8 border-2 border-amber-200">
                        <i class="fa-solid fa-tree text-4xl text-green-700 mb-2"></i>
                        <h3 class="font-bold text-xl">Transitional Forestry</h3>
                        <p class="text-sm text-gray-700">Using exotic trees as a nursery.</p>
                    </div>
                    
                    <!-- Clickable 18 Plots Card -->
                    <div onclick="openSitesModal()" class="cursor-pointer bg-white text-moss-deep p-6 rounded-2xl shadow-lg transform -rotate-2 hover:rotate-0 hover:scale-105 transition duration-300 border-2 border-gray-100 hover:border-moss-DEFAULT group">
                        <i class="fa-solid fa-map-location-dot text-4xl text-moss-DEFAULT mb-2 group-hover:animate-bounce"></i>
                        <h3 class="font-bold text-xl group-hover:underline">18 Plots</h3>
                        <p class="text-sm text-gray-600">Click to view map locations</p>
                    </div>

                    <div class="bg-moss-light text-moss-deep p-6 rounded-2xl shadow-lg transform rotate-2 hover:rotate-0 transition duration-300 mt-8 border-2 border-green-300">
                        <i class="fa-solid fa-water text-4xl text-white mb-2"></i>
                        <h3 class="font-bold text-xl">Bryophytes</h3>
                        <p class="text-sm font-bold text-white">Vital ecosystem engineers.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- INTRODUCTION SECTION -->
        <div id="intro" class="section-hidden max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-moss-deep" data-aos="fade-down">The Research Context</h2>
                <button onclick="speakText('intro')" class="bg-white border-2 border-moss-DEFAULT text-moss-deep px-4 py-2 rounded-full font-bold shadow-sm hover:bg-moss-light hover:text-white transition">
                    <i class="fa-solid fa-volume-high"></i> Listen
                </button>
            </div>
            
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <!-- Card 1 -->
                <div class="flip-card h-80 w-full" data-aos="zoom-in">
                    <div class="flip-card-inner shadow-xl rounded-2xl">
                        <div class="flip-card-front bg-white border-b-8 border-gray-200">
                            <i class="fa-solid fa-globe-americas text-5xl text-blue-500 mb-4"></i>
                            <h3 class="text-xl font-bold text-moss-deep">Global Biodiversity Loss</h3>
                            <p class="text-gray-500 mt-2 text-sm">Hover to reveal details</p>
                        </div>
                        <div class="flip-card-back border-b-8 border-black border-opacity-20 flex flex-col justify-between">
                            <p class="text-sm leading-relaxed">Forests are declining globally. We need to understand how land use changes, like plantation forestry, affect biodiversity compared to native forests.</p>
                            <button onclick="event.stopPropagation(); openResearchModal('Impact of Plantation Forestry on Global Biodiversity')" class="mt-4 bg-white text-moss-deep px-4 py-2 rounded-lg font-bold text-xs hover:bg-gray-100 w-full">
                                <i class="fa-solid fa-microscope"></i> Latest Research
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Card 2 -->
                <div class="flip-card h-80 w-full" data-aos="zoom-in" data-aos-delay="100">
                    <div class="flip-card-inner shadow-xl rounded-2xl">
                        <div class="flip-card-front bg-white border-b-8 border-gray-200">
                            <i class="fa-solid fa-seedling text-5xl text-moss-DEFAULT mb-4"></i>
                            <h3 class="text-xl font-bold text-moss-deep">Transitional Forestry</h3>
                            <p class="text-gray-500 mt-2 text-sm">Can exotics help?</p>
                        </div>
                        <div class="flip-card-back bg-moss-DEFAULT border-b-8 border-black border-opacity-20 flex flex-col justify-between">
                            <p class="text-sm leading-relaxed">Exotic plantations might act as "nurseries" for native plants, shading out weeds and providing a microclimate for native seedlings to establish.</p>
                            <button onclick="event.stopPropagation(); openResearchModal('Exotic Forests as Nurseries for Native Plants')" class="mt-4 bg-white text-moss-deep px-4 py-2 rounded-lg font-bold text-xs hover:bg-gray-100 w-full">
                                <i class="fa-solid fa-microscope"></i> Latest Research
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Card 3 -->
                <div class="flip-card h-80 w-full" data-aos="zoom-in" data-aos-delay="200">
                    <div class="flip-card-inner shadow-xl rounded-2xl">
                        <div class="flip-card-front bg-white border-b-8 border-gray-200">
                            <i class="fa-solid fa-cloud-rain text-5xl text-gray-400 mb-4"></i>
                            <h3 class="text-xl font-bold text-moss-deep">Bryophytes Matter</h3>
                            <p class="text-gray-500 mt-2 text-sm">Why mosses?</p>
                        </div>
                        <div class="flip-card-back bg-earth text-gray-800 border-b-8 border-black border-opacity-20 flex flex-col justify-between">
                            <p class="text-sm leading-relaxed font-semibold">Bryophytes (mosses/liverworts) are "ecosystem engineers". They effect soil dynamics and water retention but are often ignored in surveys.</p>
                            <button onclick="event.stopPropagation(); openResearchModal('Ecological Role of Bryophytes in Forests')" class="mt-4 bg-moss-deep text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-moss-dark w-full">
                                <i class="fa-solid fa-microscope"></i> Latest Research
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border-l-8 border-gold-DEFAULT" data-aos="fade-up">
                <h3 class="text-2xl font-bold text-moss-deep mb-4">Key Research Questions</h3>
                <ul class="space-y-3 text-gray-700">
                    <li class="flex items-center gap-3">
                        <span class="bg-moss-deep text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">1</span>
                        <p>Does understorey plant diversity differ between native and exotic forests?</p>
                    </li>
                    <li class="flex items-center gap-3">
                        <span class="bg-moss-deep text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">2</span>
                        <p>Is there a correlation between bryophyte and vascular plant diversity?</p>
                    </li>
                    <li class="flex items-center gap-3">
                        <span class="bg-moss-deep text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">3</span>
                        <p>Does silvicultural management (disturbance) impact diversity?</p>
                    </li>
                </ul>
            </div>
        </div>

        <!-- METHODS SECTION -->
        <div id="methods" class="section-hidden max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-moss-deep">Methods & Sites</h2>
                <button onclick="speakText('methods')" class="bg-white border-2 border-moss-DEFAULT text-moss-deep px-4 py-2 rounded-full font-bold shadow-sm hover:bg-moss-light hover:text-white transition">
                    <i class="fa-solid fa-volume-high"></i> Listen
                </button>
            </div>
            
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Sites Column -->
                <div class="w-full md:w-1/2 space-y-4">
                    <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-moss-DEFAULT" data-aos="fade-right">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg text-gray-800"><i class="fa-solid fa-map-pin mr-2 text-red-500"></i>The Rule of 300m</h3>
                            <button onclick="openResearchModal('Seed Dispersal Distance in Forests')" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-600"><i class="fa-solid fa-circle-info"></i> More</button>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">To ensure fair comparison, every exotic forest plot chosen was within 300 meters of a native seed source.</p>
                    </div>
                    
                    <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-moss-DEFAULT" data-aos="fade-right" data-aos-delay="100">
                        <h3 class="font-bold text-lg text-gray-800"><i class="fa-solid fa-ruler-combined mr-2 text-blue-500"></i>Plot Design</h3>
                        <p class="text-sm text-gray-600 mt-2">18 plots (125m x 60m). Inside each plot, 30 quadrats (0.5m x 0.5m) were randomly placed to count every plant.</p>
                    </div>

                    <div class="bg-moss-deep text-white p-6 rounded-xl shadow-xl mt-4" data-aos="fade-up">
                        <h3 class="font-bold text-xl mb-4 text-gold-DEFAULT">Study Sites in Otago</h3>
                        <ul class="space-y-2 text-sm">
                            <li><i class="fa-solid fa-location-dot mr-2"></i> <strong>Orokonui:</strong> Eucalypts vs KƒÅnuka</li>
                            <li><i class="fa-solid fa-location-dot mr-2"></i> <strong>Saddle Hill:</strong> 5 canopy types!</li>
                            <li><i class="fa-solid fa-location-dot mr-2"></i> <strong>Cedar Creek:</strong> Pine vs MƒÅnuka</li>
                            <li><i class="fa-solid fa-location-dot mr-2"></i> <strong>Flagstaff:</strong> Douglas Fir vs MƒÅnuka</li>
                            <li><i class="fa-solid fa-location-dot mr-2"></i> <strong>Rankleburn:</strong> Old forestry site</li>
                            <li><i class="fa-solid fa-location-dot mr-2"></i> <strong>Ross Creek:</strong> Dunedin's first plantation</li>
                            <li><i class="fa-solid fa-location-dot mr-2"></i> <strong>Silverpeaks:</strong> High altitude site</li>
                        </ul>
                    </div>
                </div>

                <!-- Analysis Column -->
                <div class="w-full md:w-1/2 bg-white rounded-2xl shadow-xl p-6 border-b-8 border-earth">
                    <h3 class="font-bold text-xl text-earth-dark mb-4 text-gray-800">What was measured?</h3>
                    
                    <div class="space-y-4">
                        <details class="group p-4 bg-gray-50 rounded-lg cursor-pointer border border-gray-200">
                            <summary class="font-bold text-moss-dark list-none flex justify-between items-center">
                                <span>üåø Vascular Plants</span>
                                <span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span>
                            </summary>
                            <p class="text-sm text-gray-600 mt-2">All ferns, grasses, shrubs, and trees were identified and counted. Classified as Native or Exotic.</p>
                        </details>

                        <details class="group p-4 bg-gray-50 rounded-lg cursor-pointer border border-gray-200">
                            <summary class="font-bold text-moss-dark list-none flex justify-between items-center">
                                <span>üíß Non-Vascular (Bryophytes)</span>
                                <span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span>
                            </summary>
                            <p class="text-sm text-gray-600 mt-2">Mosses and Liverworts identified under microscope. Substrate noted (Soil, Rock, Dead Wood, Live Bark).</p>
                            <button onclick="openResearchModal('Bryophyte Identification Techniques')" class="mt-2 text-xs text-blue-500 hover:underline">Learn about methodology</button>
                        </details>

                        <details class="group p-4 bg-gray-50 rounded-lg cursor-pointer border border-gray-200">
                            <summary class="font-bold text-moss-dark list-none flex justify-between items-center">
                                <span>üß™ Soil & Environment</span>
                                <span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span>
                            </summary>
                            <p class="text-sm text-gray-600 mt-2">Soil samples taken for analysis (Sodium, Nitrogen, etc.). Canopy cover measured with hemispheric photography.</p>
                        </details>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULTS SECTION -->
        <div id="results" class="section-hidden max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-moss-deep">Key Findings</h2>
                <button onclick="speakText('results')" class="bg-white border-2 border-moss-DEFAULT text-moss-deep px-4 py-2 rounded-full font-bold shadow-sm hover:bg-moss-light hover:text-white transition">
                    <i class="fa-solid fa-volume-high"></i> Listen
                </button>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-10">
                <!-- Finding 1 -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-moss-DEFAULT" data-aos="flip-up">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">1. Total Diversity Surprise</h3>
                    <p class="text-gray-600 mb-4">Contrary to expectations, there was <strong>no significant difference</strong> in total species richness between Native and Exotic canopies.</p>
                    <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                        <div class="bg-moss-DEFAULT h-4 rounded-full" style="width: 50%"></div>
                    </div>
                    <div class="flex justify-between text-xs font-bold text-moss-deep">
                        <span>Native Canopy</span>
                        <span>Exotic Canopy (Equal)</span>
                    </div>
                    <button onclick="openResearchModal('Native vs Exotic Forest Biodiversity Comparison')" class="mt-4 text-sm text-moss-DEFAULT font-bold hover:underline"><i class="fa-solid fa-plus"></i> Why is this surprising?</button>
                </div>

                <!-- Finding 2 -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-gold-DEFAULT" data-aos="flip-up" data-aos-delay="100">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">2. Native vs Exotic Plants</h3>
                    <p class="text-gray-600 mb-4">However, Native canopies supported significantly more <strong>Native vascular plants</strong> than exotic canopies did.</p>
                    <div class="flex items-end gap-2 h-20 mt-4">
                        <div class="bg-moss-deep w-1/2 rounded-t-lg flex items-center justify-center text-white font-bold h-full">Native Canopy</div>
                        <div class="bg-moss-light w-1/2 rounded-t-lg flex items-center justify-center text-white font-bold h-3/5">Exotic Canopy</div>
                    </div>
                    <p class="text-center text-xs mt-1 text-gray-600">Native Plant Richness</p>
                </div>
            </div>

            <!-- Management & Sodium -->
            <div class="bg-moss-deep text-white rounded-3xl p-8 shadow-2xl relative overflow-hidden" data-aos="zoom-in-up">
                <div class="absolute top-0 right-0 opacity-10">
                    <i class="fa-solid fa-tractor text-9xl"></i>
                </div>
                
                <h3 class="text-2xl font-bold text-gold-DEFAULT mb-6">Management & Chemicals</h3>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-bold text-lg mb-2"><i class="fa-solid fa-scissors mr-2"></i>Intermittent vs Continuous</h4>
                        <p class="text-sm opacity-90 mb-4 leading-relaxed">
                            <strong>Intermittent Management</strong> (Harsh but rare, e.g., clear-felling every 30 years) actually supported HIGHER diversity than <strong>Continuous Management</strong> (regular low-intensity weeding/trapping).
                        </p>
                        <p class="text-xs italic bg-white/10 p-2 rounded">Why? Intermittent disturbance mimics natural events and leaves Coarse Woody Debris (logs) which mosses love!</p>
                        <button onclick="openResearchModal('Intermediate Disturbance Hypothesis in Forests')" class="mt-3 bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-xs font-bold transition">Explore Disturbance Theory</button>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-lg mb-2"><i class="fa-solid fa-flask mr-2"></i>The Sodium Problem</h4>
                        <p class="text-sm opacity-90 mb-4 leading-relaxed">
                            High levels of soil <strong>Sodium (Na+)</strong> were found to decrease Moss diversity. Vascular plants didn't mind, but mosses are sensitive!
                        </p>
                        <div class="flex items-center gap-2 mt-2 bg-black/20 p-2 rounded-lg">
                            <span class="text-red-400 font-bold">Na+ ‚Üë</span>
                            <span class="h-0.5 flex-1 bg-white"></span>
                            <span class="text-green-400 font-bold">Mosses ‚Üì</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: FOREST SIMULATOR SECTION -->
        <div id="simulator" class="section-hidden max-w-5xl mx-auto">
            <h2 class="text-4xl font-extrabold text-moss-deep mb-6 text-center">‚ú® Forest Forecaster</h2>
            <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">
                Use the power of AI to simulate an ecosystem based on Aimee's thesis data. Adjust the parameters below to see how different management styles and soil conditions affect the forest understorey.
            </p>

            <div class="grid md:grid-cols-3 gap-6">
                <!-- Controls -->
                <div class="md:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border-l-8 border-purple-500">
                        <label class="block font-bold text-gray-700 mb-2">Canopy Type</label>
                        <select id="sim-canopy" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none bg-white text-gray-800">
                            <option value="Native (e.g. KƒÅnuka)">Native (e.g. KƒÅnuka)</option>
                            <option value="Exotic (e.g. Pinus radiata)">Exotic (e.g. Pinus radiata)</option>
                            <option value="Exotic (e.g. Eucalyptus)">Exotic (e.g. Eucalyptus)</option>
                        </select>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg border-l-8 border-blue-500">
                        <label class="block font-bold text-gray-700 mb-2">Management Style</label>
                        <select id="sim-management" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white text-gray-800">
                            <option value="Intermittent (High disturbance, rare)">Intermittent (Logging)</option>
                            <option value="Continuous (Low disturbance, frequent)">Continuous (Weeding)</option>
                            <option value="None (Natural)">None (Natural)</option>
                        </select>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg border-l-8 border-red-500">
                        <label class="block font-bold text-gray-700 mb-2">Soil Sodium (Na+)</label>
                        <select id="sim-sodium" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:border-red-500 focus:outline-none bg-white text-gray-800">
                            <option value="Low">Low Sodium</option>
                            <option value="High">High Sodium</option>
                        </select>
                    </div>

                    <button onclick="runSimulation()" class="w-full bg-purple-700 text-white font-bold py-4 rounded-xl shadow-xl hover:bg-purple-800 transition transform hover:scale-105">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Forecast Forest
                    </button>
                </div>

                <!-- Output -->
                <div class="md:col-span-2">
                    <div id="sim-output" class="bg-white h-full rounded-2xl shadow-xl p-8 border-4 border-dashed border-gray-300 flex items-center justify-center flex-col min-h-[400px]">
                        <i class="fa-solid fa-tree-city text-6xl text-gray-200 mb-4"></i>
                        <p class="text-gray-400 text-center text-lg">Adjust parameters and click "Forecast Forest" to generate an AI ecosystem prediction.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- DISCUSSION SECTION -->
        <div id="discussion" class="section-hidden max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-moss-deep">Discussion & Implications</h2>
                <button onclick="speakText('discussion')" class="bg-white border-2 border-moss-DEFAULT text-moss-deep px-4 py-2 rounded-full font-bold shadow-sm hover:bg-moss-light hover:text-white transition">
                    <i class="fa-solid fa-volume-high"></i> Listen
                </button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg" data-aos="fade-up">
                    <h3 class="text-xl font-bold text-earth-DEFAULT mb-2">Transitional Forestry</h3>
                    <p class="text-gray-700 leading-relaxed">
                        Since exotic forests can support native regeneration (if near a seed source), they can be used as a "nursery". We can transition these pine blocks into native forests slowly, rather than cutting them all down at once. This maintains habitat for the mosses and ferns that have established there.
                    </p>
                    <button onclick="openResearchModal('Succession in Transitional Forestry')" class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 rounded-lg transition"><i class="fa-solid fa-book mr-2"></i> Read Related Studies</button>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg" data-aos="fade-up" data-aos-delay="100">
                    <h3 class="text-xl font-bold text-earth-DEFAULT mb-2">Indicator Species</h3>
                    <p class="text-gray-700">
                        Three native species were identified as strong indicators of Native Forest conditions:
                    </p>
                    <ul class="mt-2 space-y-2 text-sm font-semibold text-moss-DEFAULT">
                        <li class="flex items-center gap-2"><i class="fa-solid fa-check"></i> 1. Blechnum procerum (Fern)</li>
                        <li class="flex items-center gap-2"><i class="fa-solid fa-check"></i> 2. Pseudopanax colensoi (Tree)</li>
                        <li class="flex items-center gap-2"><i class="fa-solid fa-check"></i> 3. Coprosma dumosa (Shrub)</li>
                    </ul>
                    <button onclick="openResearchModal('Bio-indicators in Forest Ecosystems')" class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 rounded-lg transition"><i class="fa-solid fa-book mr-2"></i> Why use indicators?</button>
                </div>
            </div>
        </div>

        <!-- QUIZ SECTION -->
        <div id="quiz" class="section-hidden max-w-4xl mx-auto text-center">
            <h2 class="text-4xl font-extrabold text-moss-deep mb-8">AI Quiz Master</h2>
            
            <div class="bg-white p-8 rounded-3xl shadow-2xl border-4 border-gold-DEFAULT max-w-3xl mx-auto relative overflow-hidden">
                <div class="absolute -top-10 -right-10 bg-gold-DEFAULT w-32 h-32 rounded-full opacity-20"></div>
                
                <h3 class="text-2xl font-bold mb-4 text-moss-deep">Test Your Knowledge</h3>
                <p class="mb-6 text-gray-600">The AI will generate a unique question based on the thesis every time.</p>
                
                <div id="quiz-container" class="text-left hidden mb-6">
                    <p id="quiz-question" class="text-xl font-bold mb-6 text-gray-800"></p>
                    <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Options injected here -->
                    </div>
                    <div id="quiz-feedback" class="mt-4 font-bold text-center text-lg hidden"></div>
                </div>

                <div id="quiz-loading" class="hidden py-8">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl text-gold-DEFAULT"></i>
                    <p class="mt-2 text-gray-500">Crafting question...</p>
                </div>

                <button onclick="generateQuiz()" class="bg-moss-DEFAULT text-white px-8 py-3 rounded-xl font-bold hover:bg-moss-dark transition transform hover:scale-105 shadow-lg border-b-4 border-moss-deep">
                    <i class="fa-solid fa-dice mr-2"></i> Generate New Question
                </button>
            </div>
        </div>

    </main>

    <!-- RESEARCH MODAL -->
    <div id="research-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 relative max-h-[90vh] flex flex-col">
            <button onclick="closeResearchModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-2xl">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h3 id="modal-title" class="text-2xl font-bold text-moss-deep mb-4 pr-8 border-b pb-2">Topic Analysis</h3>
            
            <div id="modal-content" class="overflow-y-auto pr-2 flex-1 prose prose-sm max-w-none text-gray-700">
                <!-- AI Content loads here -->
                <div class="flex flex-col items-center justify-center h-40">
                    <i class="fa-solid fa-spinner fa-spin text-4xl text-moss-DEFAULT mb-4"></i>
                    <p class="text-gray-500">Searching academic database...</p>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t flex justify-end">
                <button onclick="speakText('modal-content')" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-200 mr-2"><i class="fa-solid fa-volume-high"></i> Listen</button>
                <button onclick="closeResearchModal()" class="bg-moss-DEFAULT text-white px-6 py-2 rounded-lg font-bold hover:bg-moss-dark">Close</button>
            </div>
        </div>
    </div>

    <!-- SITES MODAL (New Feature) -->
    <div id="sites-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSitesModal()"></div>
        <div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl p-0 relative max-h-[90vh] flex flex-col overflow-hidden animate-[popIn_0.3s_ease-out]">
            
            <!-- Header -->
            <div class="bg-moss-deep text-white p-6 flex justify-between items-center">
                <div>
                    <h3 class="text-2xl font-bold"><i class="fa-solid fa-map mr-2 text-gold-DEFAULT"></i> Study Locations</h3>
                    <p class="text-green-200 text-sm">18 plots across 7 sites in Otago, New Zealand</p>
                </div>
                <button onclick="closeSitesModal()" class="text-white hover:text-red-300 text-2xl transition">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto bg-gray-50 flex-1">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Site List -->
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-moss-DEFAULT hover:shadow-md transition">
                            <h4 class="font-bold text-lg text-moss-deep">1. Orokonui Ecosanctuary</h4>
                            <p class="text-sm text-gray-600">Coastal forest. <strong>Canopy:</strong> KƒÅnuka vs Eucalyptus.</p>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mt-2 inline-block">Native Seed Source: High</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-gold-DEFAULT hover:shadow-md transition">
                            <h4 class="font-bold text-lg text-moss-deep">2. Saddle Hill</h4>
                            <p class="text-sm text-gray-600">Private land. <strong>Canopy:</strong> 5 types (Pine, Poplar, Cypress, Gum, KƒÅnuka).</p>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded mt-2 inline-block">Diverse Management</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-moss-DEFAULT hover:shadow-md transition">
                            <h4 class="font-bold text-lg text-moss-deep">3. Cedar Creek</h4>
                            <p class="text-sm text-gray-600">Near reservoir. <strong>Canopy:</strong> Pine vs MƒÅnuka.</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-moss-DEFAULT hover:shadow-md transition">
                            <h4 class="font-bold text-lg text-moss-deep">4. Flagstaff</h4>
                            <p class="text-sm text-gray-600">DCC Reserve. <strong>Canopy:</strong> Douglas Fir vs MƒÅnuka.</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-earth hover:shadow-md transition">
                            <h4 class="font-bold text-lg text-moss-deep">5. Rankleburn</h4>
                            <p class="text-sm text-gray-600">Deep gullies. <strong>Canopy:</strong> Pine/Fir vs Red Beech (Fuscospora).</p>
                            <span class="text-xs bg-amber-100 text-gray-800 px-2 py-1 rounded mt-2 inline-block">Old Forestry Site</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-moss-DEFAULT hover:shadow-md transition">
                            <h4 class="font-bold text-lg text-moss-deep">6. Ross Creek</h4>
                            <p class="text-sm text-gray-600">City reservoir. <strong>Canopy:</strong> Douglas Fir vs Red Beech.</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-moss-DEFAULT hover:shadow-md transition">
                            <h4 class="font-bold text-lg text-moss-deep">7. Silverpeaks</h4>
                            <p class="text-sm text-gray-600">High altitude. <strong>Canopy:</strong> Douglas Fir vs MƒÅnuka.</p>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                            <h5 class="font-bold text-blue-800 text-sm mb-2"><i class="fa-solid fa-info-circle"></i> Plot Design</h5>
                            <p class="text-xs text-blue-700">Each plot is 125m x 60m. All exotic plots are located within 300m of a native forest seed source to ensure fair regeneration chances.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-100 p-4 flex justify-end">
                <button onclick="closeSitesModal()" class="bg-gray-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-black transition">Close Map</button>
            </div>
        </div>
    </div>

    <!-- Floating Chat Widget -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        <!-- Chat Box -->
        <div id="chat-box" class="bg-white w-80 h-96 rounded-2xl shadow-2xl mb-4 hidden flex flex-col border-4 border-moss-deep overflow-hidden">
            <div class="bg-moss-deep text-white p-3 font-bold flex justify-between items-center">
                <span><i class="fa-solid fa-tree mr-2"></i>Forest Bot</span>
                <button onclick="toggleChat()" class="hover:text-red-300"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-3">
                <div class="bg-moss-light text-moss-deep p-2 rounded-lg text-sm self-start w-3/4">
                    I am your bryologist ready to answer any questions you have!
                </div>
            </div>
            <div class="p-2 bg-gray-100 flex gap-2">
                <input type="text" id="chat-input" placeholder="Ask a question..." class="flex-1 p-2 rounded-lg border focus:outline-none focus:border-moss-DEFAULT text-black" onkeypress="handleEnter(event)">
                <button onclick="sendMessage()" class="bg-moss-DEFAULT text-white p-2 rounded-lg hover:bg-moss-dark"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- Chat Button -->
        <button onclick="toggleChat()" class="bg-moss-deep text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition border-4 border-gold-DEFAULT">
            <i class="fa-solid fa-comment-dots"></i>
        </button>
    </div>

    <script>
        // Init AOS
        AOS.init();

        // Navigation Logic
        function switchTab(tabId) {
            // Hide all sections
            const sections = ['home', 'intro', 'methods', 'results', 'simulator', 'discussion', 'quiz'];
            sections.forEach(s => {
                const el = document.getElementById(s);
                if (el) {
                    el.classList.add('section-hidden');
                    el.classList.remove('section-active');
                }
            });

            // Show selected
            const activeSection = document.getElementById(tabId);
            if (activeSection) {
                activeSection.classList.remove('section-hidden');
                activeSection.classList.add('section-active');
            }

            // Update Nav Buttons
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById('btn-' + tabId);
            if(btn) btn.classList.add('active');
        }

        // --- SITES MODAL LOGIC ---
        function openSitesModal() {
            document.getElementById('sites-modal').classList.remove('hidden');
            document.getElementById('sites-modal').classList.add('flex');
        }

        function closeSitesModal() {
            document.getElementById('sites-modal').classList.add('hidden');
            document.getElementById('sites-modal').classList.remove('flex');
        }

        // Chat Logic
        function toggleChat() {
            const chatBox = document.getElementById('chat-box');
            chatBox.classList.toggle('hidden');
        }

        // --- SPEECH SYNTHESIS LOGIC ---
        function speakText(elementId) {
            // Cancel any current speech
            window.speechSynthesis.cancel();

            const text = document.getElementById(elementId).innerText;
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Optional: Set voice/rate
            utterance.rate = 1;
            utterance.pitch = 1;
            
            window.speechSynthesis.speak(utterance);
        }

        const API_BASE = "https://aimee-s-m-sc.vercel.app";

        async function callGemini(prompt) {
            if (API_BASE.includes("YOUR-VERCEL-APP")) {
                throw new Error("‚ö†Ô∏è API_BASE not set. See setup instructions at bottom of file.");
            }
            try {
                const response = await fetch(`${API_BASE}/api/ask`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: prompt }),
                });

                // Try to parse the response as JSON (even if it's an error)
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    // If JSON parsing fails, it might be a raw HTML error (like a Vercel 504/404)
                    throw new Error(`Server connection failed (${response.status}). Check Vercel logs.`);
                }

                // If the backend sent an error message, throw it to be displayed
                if (!response.ok) {
                    throw new Error(data.error || `Server Error: ${response.status}`);
                }

                return data.reply;
            } catch (e) {
                console.error("Gemini Call Failed:", e);
                throw e; // Propagate error
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const msgs = document.getElementById('chat-messages');
            const userText = input.value.trim();
            
            if (!userText) return;

            // Add User Message
            msgs.innerHTML += `<div class="chat-msg bg-white border border-gray-200 p-2 rounded-lg text-sm self-end ml-auto w-3/4 mb-2 shadow-sm text-right text-gray-800">${userText}</div>`;
            input.value = '';
            msgs.scrollTop = msgs.scrollHeight;

            // Loading state
            const loadingId = 'loading-' + Date.now();
            msgs.innerHTML += `<div id="${loadingId}" class="chat-msg bg-gray-200 text-gray-500 p-2 rounded-lg text-sm self-start w-3/4 mb-2">Thinking...</div>`;
            msgs.scrollTop = msgs.scrollHeight;

            try {
                // API Call
                const contextPrompt = `You are an expert on Aimee Pritchard's MSc thesis about Plant Communities in Native and Exotic Forests. Context: Higher diversity in intermittent management. Sodium hurts mosses. Answer concisely: ${userText}`;
                const reply = await callGemini(contextPrompt);

                // Remove loading and add Bot Message
                document.getElementById(loadingId).remove();
                
                // Render Markdown if possible, or just text
                const cleanReply = marked.parse(reply);
                msgs.innerHTML += `<div class="chat-msg bg-moss-light text-moss-deep p-2 rounded-lg text-sm self-start w-3/4 mb-2 shadow-sm prose prose-sm">${cleanReply}</div>`;
            } catch (e) {
                document.getElementById(loadingId).remove();
                
                // Check for specific setup errors
                let errMsg = e.message;
                if(e.message.includes("API_BASE")) {
                    errMsg = "‚ö†Ô∏è Setup Error: Please set the Vercel URL in the code!";
                } else if (e.message.includes("API Key")) {
                    errMsg = "‚ö†Ô∏è Missing Key: Add GEMINI_API_KEY in Vercel Settings.";
                }
                
                msgs.innerHTML += `<div class="chat-msg bg-red-100 text-red-800 p-2 rounded-lg text-sm self-start w-3/4 mb-2 shadow-sm border border-red-200 break-words font-bold">${errMsg}</div>`;
            }
            msgs.scrollTop = msgs.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        // --- RESEARCH MODAL LOGIC ---
        function openResearchModal(topic) {
            const modal = document.getElementById('research-modal');
            const content = document.getElementById('modal-content');
            const title = document.getElementById('modal-title');
            
            title.innerText = "Deep Dive: " + topic;
            modal.classList.remove('hidden');
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center h-40">
                    <i class="fa-solid fa-spinner fa-spin text-4xl text-moss-DEFAULT mb-4"></i>
                    <p class="text-gray-500">Consulting academic database...</p>
                </div>
            `;

            fetchExplanation(topic);
        }

        function closeResearchModal() {
            document.getElementById('research-modal').classList.add('hidden');
            window.speechSynthesis.cancel(); // Stop reading if closed
        }

        async function fetchExplanation(topic) {
            const prompt = `
                Topic: ${topic}
                Context: Aimee Pritchard's thesis on Forest Ecology.
                
                Task:
                1. Explain this concept in depth (2 paragraphs) in the context of forest ecology and management.
                2. Provide 3 specific citations of OTHER RELEVANT research papers (Authors, Year) that support or contrast with this topic.
                3. Keep the tone academic but accessible.
                
                Format as Markdown with bold headings.
            `;

            try {
                const text = await callGemini(prompt);
                document.getElementById('modal-content').innerHTML = marked.parse(text);
            } catch (e) {
                document.getElementById('modal-content').innerHTML = `
                    <div class="text-center text-red-500 p-4">
                        <i class="fa-solid fa-triangle-exclamation text-3xl mb-2"></i><br>
                        Could not fetch research data.<br>
                        <span class="text-sm text-gray-500">${e.message}</span>
                    </div>
                `;
            }
        }

        // --- FOREST FORECASTER LOGIC ---
        async function runSimulation() {
            const canopy = document.getElementById('sim-canopy').value;
            const management = document.getElementById('sim-management').value;
            const sodium = document.getElementById('sim-sodium').value;
            const outputDiv = document.getElementById('sim-output');

            outputDiv.innerHTML = `
                <div class="flex flex-col items-center animate-pulse">
                    <i class="fa-solid fa-seedling text-6xl text-moss-DEFAULT mb-4"></i>
                    <p class="text-xl font-bold text-moss-dark">Simulating Ecosystem...</p>
                    <p class="text-sm text-gray-500">Applying thesis variables...</p>
                </div>
            `;

            const prompt = `
                Act as a Forest Ecology Simulator based on Aimee Pritchard's thesis.
                
                Simulate a forest plot with these parameters:
                1. Canopy: ${canopy}
                2. Management: ${management}
                3. Soil Sodium: ${sodium}

                Based on the thesis findings (Intermittent management increases diversity via woody debris, Sodium reduces moss diversity, Native canopies support more native species), describe the resulting understorey.
                
                Format the response with:
                - A bold creative Title for this forest type.
                - A "Biodiversity Forecast" rating (Low/Medium/High).
                - A description of the "Moss Layer" (Health/Diversity).
                - A description of the "Vascular Plant Layer" (Native vs Exotic presence).
                - Use emojis. Keep it concise but scientific.
            `;

            try {
                const prediction = await callGemini(prompt);
                outputDiv.innerHTML = `<div class="prose prose-sm w-full max-w-none text-left text-gray-800">${marked.parse(prediction)}</div>`;
                outputDiv.classList.remove('border-dashed', 'border-gray-300', 'border-red-500');
                outputDiv.classList.add('border-purple-200');
            } catch (e) {
                outputDiv.innerHTML = `<div class="text-center text-red-500 font-bold"><i class="fa-solid fa-triangle-exclamation text-4xl mb-2"></i><br>${e.message}</div>`;
                outputDiv.classList.add('border-red-500');
            }
        }

        // --- DYNAMIC QUIZ LOGIC ---
        async function generateQuiz() {
            const container = document.getElementById('quiz-container');
            const loading = document.getElementById('quiz-loading');
            const questionEl = document.getElementById('quiz-question');
            const optionsEl = document.getElementById('quiz-options');
            const feedbackEl = document.getElementById('quiz-feedback');

            container.classList.add('hidden');
            loading.classList.remove('hidden');
            feedbackEl.classList.add('hidden');
            optionsEl.innerHTML = '';

            const prompt = `
                Generate a multiple-choice question based on Aimee Pritchard's thesis "Canopy and Management Influences on Plant Communities".
                Focus on topics like: Bryophytes as indicators, Sodium effects, Intermittent vs Continuous management, or Native vs Exotic canopy influence.
                
                Return ONLY a JSON object with this exact format (no markdown, just raw JSON):
                {
                    "question": "The question text here?",
                    "options": ["Wrong Answer 1", "Correct Answer", "Wrong Answer 2", "Wrong Answer 3"],
                    "correctIndex": 1,
                    "explanation": "Short explanation of why."
                }
            `;

            try {
                let text = await callGemini(prompt);
                // Cleanup json if it comes with markdown blocks
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const quizData = JSON.parse(text);

                loading.classList.add('hidden');
                container.classList.remove('hidden');
                
                questionEl.innerText = quizData.question;
                questionEl.className = "text-xl font-bold mb-6 text-gray-800"; // Reset classes

                quizData.options.forEach((opt, index) => {
                    const btn = document.createElement('button');
                    btn.className = "bg-gray-100 hover:bg-gray-200 p-4 rounded-xl text-left border-2 border-transparent transition-all text-gray-800 font-medium";
                    btn.innerText = opt;
                    btn.onclick = () => checkAnswer(index, quizData.correctIndex, quizData.explanation, btn);
                    optionsEl.appendChild(btn);
                });

            } catch (e) {
                console.error(e);
                loading.classList.add('hidden');
                
                let msg = "AI Error. Try again.";
                if (e.message.includes("API_BASE")) msg = "‚ö†Ô∏è Setup Required: Update API_BASE URL in code.";
                else if (e.message.includes("Server Error")) msg = "‚ö†Ô∏è Backend Connection Failed. Check Vercel.";
                
                container.classList.remove('hidden');
                questionEl.innerHTML = `<span class="text-red-500">${msg}</span>`;
                questionEl.className = "text-xl font-bold mb-6 text-center";
            }
        }

        function checkAnswer(selectedIndex, correctIndex, explanation, btnElement) {
            const feedbackEl = document.getElementById('quiz-feedback');
            const allBtns = document.getElementById('quiz-options').children;

            for (let btn of allBtns) {
                btn.disabled = true;
                btn.classList.add('opacity-50');
            }

            if (selectedIndex === correctIndex) {
                btnElement.classList.remove('bg-gray-100', 'opacity-50');
                btnElement.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                feedbackEl.innerHTML = `<span class="text-green-600"><i class="fa-solid fa-check-circle"></i> Correct!</span> <br><span class="text-sm font-normal text-gray-600">${explanation}</span>`;
            } else {
                btnElement.classList.remove('bg-gray-100', 'opacity-50');
                btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                
                // Highlight correct one
                allBtns[correctIndex].classList.remove('opacity-50');
                allBtns[correctIndex].classList.add('bg-green-100', 'border-green-500');

                feedbackEl.innerHTML = `<span class="text-red-600"><i class="fa-solid fa-xmark-circle"></i> Incorrect.</span> <br><span class="text-sm font-normal text-gray-600">${explanation}</span>`;
            }
            feedbackEl.classList.remove('hidden');
        }
    </script>

    <!-- 
    ‚≠ê "FOR DUMMIES" MASTER GUIDE: HOW TO PUT THIS ONLINE ‚≠ê

    If you haven't touched this in months, don't worry. Just follow these steps exactly to make the AI Chatbot and Mystery Questions work.

    --- PHASE 1: GET YOUR FILES READY ON YOUR COMPUTER ---

    1. Create a Folder:
       - Create a new folder on your Desktop named "science-revision".

    2. Save the Website:
       - Save this file you are looking at right now as "index.html" inside that folder.

    3. Create the "Backend" (The brain):
       - Inside "science-revision", create a new folder named "api" (lowercase).
       - Inside "api", create a new text file named "ask.js".
       - Paste the code below into "ask.js" and save it:

       // --- COPY START (api/ask.js) ---
       export const config = { runtime: 'edge' };
       
       export default async function handler(req) {
         // 1. Setup CORS (Allows your site to talk to this backend)
         const corsHeaders = {
           "Access-Control-Allow-Origin": "*", 
           "Access-Control-Allow-Methods": "POST, OPTIONS",
           "Access-Control-Allow-Headers": "Content-Type",
         };
       
         // 2. Handle the "Pre-flight" check
         if (req.method === "OPTIONS") {
           return new Response(null, { status: 200, headers: corsHeaders });
         }
         
         // 3. Block anything that isn't a POST request
         if (req.method !== "POST") {
           return new Response(JSON.stringify({ error: "Method not allowed" }), { status: 405, headers: corsHeaders });
         }
       
         try {
           // 4. Get the message from the website
           const { message } = await req.json();
           const apiKey = process.env.GEMINI_API_KEY; 
       
           if (!apiKey) {
             return new Response(JSON.stringify({ error: "Server Error: No API Key found in Vercel Settings." }), { status: 500, headers: corsHeaders });
           }
       
           // 5. Send to Google Gemini (Using 2.5 Flash model)
           // Using the preview version to ensure availability
           const googleResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
             method: "POST",
             headers: { "Content-Type": "application/json" },
             body: JSON.stringify({ contents: [{ parts: [{ text: message }] }] }),
           });
       
           const data = await googleResponse.json();
           
           // 6. Check for AI errors
           if (data.error) {
              return new Response(JSON.stringify({ error: data.error.message }), { status: 500, headers: corsHeaders });
           }

           const replyText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "AI Error: No response generated.";
       
           // 7. Send the answer back to the website
           return new Response(JSON.stringify({ reply: replyText }), { status: 200, headers: corsHeaders });
         } catch (error) {
           return new Response(JSON.stringify({ error: "Internal Server Error: " + error.message }), { status: 500, headers: corsHeaders });
         }
       }
       // --- COPY END ---

    --- PHASE 2: PUT IT ON GITHUB ---

    1. Log in to GitHub.com.
    2. Click the "+" icon (top right) -> "New Repository".
    3. Name it "science-revision". Make it Public. Click "Create repository".
    4. Click the link that says "uploading an existing file".
    5. Drag your "index.html" file AND your "api" folder into the upload box.
    6. Click the green "Commit changes" button.

    --- PHASE 3: DEPLOY TO VERCEL ---

    1. Go to Vercel.com and log in.
    2. Click "Add New..." -> "Project".
    3. You will see your "science-revision" repo in the list. Click "Import".
    4. Click the blue "Deploy" button.
    5. Wait ~1 minute. When you see confetti, click the picture of your site.
    6. COPY the URL from the browser bar (e.g., https://science-revision.vercel.app).

    --- PHASE 4: ACTIVATE THE AI BRAIN ---

    1. Get the Key:
       - Go to https://aistudio.google.com/app/apikey
       - Click "Create API Key". Copy that long string of random letters.

    2. Add it to Vercel:
       - Go back to your project dashboard on Vercel.
       - Click "Settings" (top menu) -> "Environment Variables" (left menu).
       - In "Key", type: GEMINI_API_KEY
       - In "Value", paste your Google Key.
       - Click "Save".

    3. Restart:
       - Click "Deployments" (top menu).
       - Click the three dots (...) next to the top item -> "Redeploy".
       - Click "Redeploy" again. (This creates the connection).

    --- PHASE 5: FINAL CONNECTION ---

    1. Go back to your computer. Open "index.html".
    2. Scroll to the bottom script section.
    3. Find: const API_BASE = "https://YOUR-VERCEL-APP.vercel.app";
    4. Replace the URL with your REAL Vercel URL you copied in Phase 3.
    5. Save the file.
    6. Go back to your GitHub repo -> Add File -> Upload files -> Upload the fixed index.html -> Commit changes.

    DONE! Wait 30 seconds, refresh your live site, and the bot will work!
    -->
</body>
</html>
